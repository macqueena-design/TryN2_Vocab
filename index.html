<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT N2 詞彙複習挑戰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --p: #4a90e2; --s: #4caf50; --e: #f44336; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #app { background: white; width: 95%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .screen { display: none; }
        .active { display: block; }
        .word { font-size: 34px; font-weight: bold; margin: 20px 0; color: #333; }
        .hint { height: 25px; margin-bottom: 15px; font-weight: bold; }
        .options { display: grid; gap: 10px; }
        button { padding: 15px; font-size: 17px; border: 2px solid #eee; border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; }
        .correct { background: var(--s) !important; color: white; border-color: var(--s); }
        .wrong { background: var(--e) !important; color: white; border-color: var(--e); cursor: not-allowed; }
        .stats { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 15px; }
        .main-btn { background: var(--p); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 18px; margin-top: 10px; }
        select { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; }
        #error-msg { color: var(--e); font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div id="loading">正在讀取 ...<br><span id="error-msg"></span></div>

    <div id="menu-screen" class="screen">
        <h1>N2 詞彙挑戰 ⚡</h1>
        <p>答錯，請重試</p>
        <select id="chapter-select"><option value="all">全部章節</option></select>
        <button class="main-btn" onclick="startGame()">開始練習</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="stats"><span>得分: <b id="score">0</b></span><span>剩餘: <b id="rem">0</b></span></div>
        <div class="word" id="q-word"></div>
        <div id="hint" class="hint"></div>
        <div class="options" id="options"></div>
    </div>

    <div id="result-screen" class="screen">
        <h1>練習完成！</h1>
        <p>最終得分：<span id="final-score" style="font-size: 24px; color: var(--p);">0</span></p>
        <button class="main-btn" onclick="location.reload()">回首頁</button>
    </div>
</div>

<script>
    let allData = [], quizData = [], current = null, score = 0, canClick = true, isFirst = true;

    // 1. 讀取 CSV 
    Papa.parse("TryN2_Vocab.csv", {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(res) {
            const data = res.data;
            if (data.length === 0) { showError("CSV 檔案是空的"); return; }
            
            // 自動識別欄位
            const keys = Object.keys(data[0]);
            const jpKey = keys.find(k => k.includes("日文"));
            const zhKey = keys.find(k => k.includes("中文"));
            const chKey = keys.find(k => k.includes("章節"));

            if (!jpKey || !zhKey) { showError("找不到 '日文' 或 '中文' 欄位"); return; }

            allData = data.map(r => ({ ch: r[chKey] || "1", jp: r[jpKey], zh: r[zhKey] }));
            document.getElementById('loading').style.display = 'none';
            initMenu();
        },
        error: function() { showError("無法載入 ，請確認檔案在同資料夾"); }
    });

    function showError(m) { document.getElementById('error-msg').textContent = "錯誤: " + m; }

    function initMenu() {
        document.getElementById('menu-screen').classList.add('active');
        const chapters = [...new Set(allData.map(d => d.ch))].filter(Boolean).sort((a,b)=>a-b);
        const sel = document.getElementById('chapter-select');
        chapters.forEach(c => {
            const o = document.createElement('option');
            o.value = c; o.textContent = "第 " + c + " 章";
            sel.appendChild(o);
        });
    }

    function startGame() {
        const ch = document.getElementById('chapter-select').value;
        quizData = ch === 'all' ? [...allData] : allData.filter(d => d.ch === ch);
        quizData.sort(() => Math.random() - 0.5);
        score = 0;
        showScreen('game-screen');
        nextQ();
    }

    function nextQ() {
        if (quizData.length === 0) {
            showScreen('result-screen');
            document.getElementById('final-score').textContent = score;
            return;
        }
        canClick = true;
        isFirst = true;
        current = quizData.pop();
        document.getElementById('q-word').textContent = current.jp;
        document.getElementById('hint').textContent = "";
        document.getElementById('rem').textContent = quizData.length;
        
        let opts = [current.zh];
        while(opts.length < 4) {
            let r = allData[Math.floor(Math.random()*allData.length)].zh;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        const div = document.getElementById('options');
        div.innerHTML = '';
        opts.forEach(o => {
            const b = document.createElement('button');
            b.textContent = o;
            b.onclick = () => {
                if(!canClick || b.disabled) return;
                if(o === current.zh) {
                    b.classList.add('correct');
                    document.getElementById('hint').textContent = "正解";
                    document.getElementById('hint').style.color = "var(--s)";
                    canClick = false;
                    if(isFirst) { score += 10; document.getElementById('score').textContent = score; }
                    setTimeout(nextQ, 2200); // 停 2.2秒
                } else {
                    b.classList.add('wrong');
                    b.disabled = true;
                    isFirst = false;
                    document.getElementById('hint').textContent = "不對，再試一次！";
                    document.getElementById('hint').style.color = "var(--e)";
                }
            };
            div.appendChild(b);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
